---

import ArenaLayout from "../layouts/ArenaLayout.astro";

import "../assets/css/arenagame.css";
import "../assets/bootstrap/themes/sketchy/bootstrap.css";

---

<ArenaLayout title="Jugar en Arena">
  <main>
    <div
      id="loading"
      class="row justify-content-center align-items-center g-2"
      style="height: 50vh;"
    >
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <div
      class="modal fade"
      id="modalNombre"
      tabindex="-1"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      role="dialog"
      aria-labelledby="modalTitleId"
      aria-hidden="true"
    >
      <div
        class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-sm"
        role="document"
      >
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitleId">Jugador(a)</h5>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <form action="javascript:void(0);" method="post">
                <div class="form-floating mb-3">
                  <input
                    required
                    type="text"
                    class="form-control"
                    name="txtNombre"
                    id="txtNombre"
                    placeholder=""
                  />
                  <label for="formId1">Ingresa tu nombre</label>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                    onclick="window.location='index.html'">Cancelar</button
                  >
                  <button type="submit" class="btn btn-primary">¡Jugar!</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="modalResult"
      tabindex="-1"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      role="dialog"
      aria-labelledby="modalTitleId2"
      aria-hidden="true"
    >
      <div
        class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-sm"
        role="document"
      >
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitleId2">Resultado</h5>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-primary">
                <thead>
                  <tr>
                    <th scope="col">Dato</th>
                    <th scope="col">Valor</th>
                  </tr>
                </thead>
                <tbody id="resultTabla"> </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal">Ok</button
            >
          </div>
        </div>
      </div>
    </div>

    <div class="container oculto" id="divPrincipal">
      <div class="row align-items-center">
        <div id="vidas" class="col">
          Vidas: <span class="spanVidas"></span>
        </div>
        <div id="puntos" class="col">
          Puntos: <span class="spanPuntos">0</span>
        </div>
        <div id="rendirse" class="col">
          <button
            name="btnRendirse"
            id="btnRendirse"
            class="btn btn-primary"
            type="button"
          >
            Rendirse
          </button>
        </div>
      </div>

      <div id="verbo" class="row">
        <div class="col-12 text-center">
          Verbo: <span class="spanVerbo"></span>
        </div>
      </div>

      <div id="pista" class="row">
        <div class="col-12 text-center">
          <span class="spanPista"></span>
        </div>
      </div>

      <div class="row">
        <div class="col-12 justify-content-center" id="divHangman">
          <img
            id="img1"
            src="./img/hangman/baseH.png"
            width="220"
            height="200"
          />
          <img
            id="img2"
            src="./img/hangman/head.png"
            width="220"
            height="200"
            class="oculto"
          />
          <img
            id="img3"
            src="./img/hangman/body.png"
            width="220"
            height="200"
            class="oculto"
          />
          <img
            id="img4"
            src="./img/hangman/ArmL.png"
            width="220"
            height="200"
            class="oculto"
          />
          <img
            id="img5"
            src="./img/hangman/ArmR.png"
            width="220"
            height="200"
            class="oculto"
          />
          <img
            id="img6"
            src="./img/hangman/LegL.png"
            width="220"
            height="200"
            class="oculto"
          />
          <img
            id="img7"
            src="./img/hangman/LegR.png"
            width="220"
            height="200"
            class="oculto"
          />
        </div>
      </div>

      <div class="row">
        <div id="divBotones" class="col-12 text-center"></div>
      </div>

      <div class="row">
        <div id="divAdivinaPasadoTipo" class="col-12 d-none">
          <form
            action="javascript:void(0);"
            method="post"
            class="form"
            id="formulario"
          >
            <label class="form-label">Selecciona el tipo de verbo: </label>
            <div class="form-check mb-2">
              <input
                class="form-check-input"
                type="radio"
                name="tipoV"
                id="regular"
                value="r"
                checked
              />
              <label class="form-check-label" for="regular"> Regular </label>
            </div>
            <div class="form-check mb-2">
              <input
                class="form-check-input"
                type="radio"
                name="tipoV"
                id="irregular"
                value="i"
              />
              <label class="form-check-label" for="irregular">
                Irregular
              </label>
            </div>
            <div class="mb-2">
              <input
                required
                type="text"
                class="form-control"
                name="txtPasado"
                id="txtPasado"
                autocomplete="off"
                aria-describedby="helpId"
                placeholder="Simple past"
              />
              <small id="helpId" class="form-text text-muted"></small>
            </div>

            <div class="d-grid gap-2">
              <button
                type="submit"
                name="btnSubmit"
                id="btnSubmit"
                class="btn btn-primary"
              >
                Enviar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Accede a la variable inyectada por Astro
    const apiUrl = import.meta.env.PUBLIC_API_URL;
    window.API_URL = apiUrl;
  </script>

  <script>
    // Prevent multiple initializations
    if (!window.hangmanAppInitialized) {
      window.hangmanAppInitialized = true;

      // Esperar a que DOMContentLoaded para manipular los elementos
      document.addEventListener("DOMContentLoaded", () => {
        // SOLUCIÓN AL PROBLEMA: Eliminar todos los spinners y espacios adicionales
        const allSpinners = document.querySelectorAll(
          '.spinner-border, [role="status"]',
        );
        allSpinners.forEach((spinner) => {
          // Remover el elemento completo en lugar de solo ocultarlo
          if (spinner && spinner.parentNode) {
            spinner.parentNode.removeChild(spinner);
          }
        });

        // Asegurarse de que solo haya un elemento main visible
        const mainElements = document.querySelectorAll("main");
        if (mainElements.length > 1) {
          // Mantener solo el primer main que contiene el juego
          for (let i = 1; i < mainElements.length; i++) {
            if (mainElements[i] && mainElements[i].parentNode) {
              mainElements[i].parentNode.removeChild(mainElements[i]);
            }
          }
        }
      });

      window.hangmanApp = {
        spanVidas: null,
        spanPuntos: null,
        spanVerbo: null,
        spanPista: null,
        divHangman: null,
        divBotones: null,
        divAdivinaPasadoTipo: null,
        resultTabla: null,
        nombre: null,
        verboJuega: null,
        pasadoUsr: null,
        tipoUsr: null,
        vidas: 3,
        pistaDespuesDe: 3,
        perdioLasVidas: false,
        seRindio: false,
        errores: 0,
        aciertos: 0,
        intentos: 6,
        verbos: [],
        verboDashes: [],
        verboArray: [],
        datosjuego: [],
        puntos: 0,
        spinner: null,
        modalNombre: null,

        randomKey(max) {
          return Math.floor(Math.random() * max);
        },

        async leerVerbos() {
          try {
            const data = await fetch(`${window.API_URL}/api/words?userId=1`);
            const verbos = await data.json();
            this.verbos = verbos;
            this.iniciar();
          } catch (error) {
            console.error("Error loading verbs:", error);
          }
        },

        seleccionaVerbo() {
          const n = this.verbos.length;

          if (n == 0) {
            this.terminar();
            return null;
          }

          const key = this.randomKey(n);
          const verbo = this.verbos[key];
          this.verbos.splice(key, 1);

          return verbo;
        },

        iniciar() {
          for (let i = 2; i <= 7; i++) {
            document.getElementById(`img${i}`).style.visibility = "hidden";
          }

          this.spinner.classList.add("d-none");

          this.verboJuega = this.seleccionaVerbo();
          this.errores = 0;
          this.aciertos = 0;
          this.intentos = 6;
          this.spanVidas.innerHTML = "♥".repeat(this.vidas);
          this.verboArray = this.verboJuega["word"].split("");
          this.verboDashes = Array(this.verboArray.length).fill("_");

          this.spanVerbo.innerHTML = this.verboDashes.join("   ");
          this.spanPista.classList.add("oculto");
          this.spanPista.innerHTML = this.verboJuega["clue"];

          this.crearBotones();
          this.divBotones.classList.remove("d-none");
          this.divAdivinaPasadoTipo.classList.add("oculto");

          document.getElementById("divPrincipal").classList.remove("oculto");
        },

        crearBotones() {
          const contenedor = document.getElementById("divBotones");
          contenedor.innerHTML = "";
          const alfabeto = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

          alfabeto.split("").forEach((letra) => {
            const boton = document.createElement("button");
            boton.type = "button";
            boton.id = letra;
            boton.textContent = letra;
            boton.className = "botonLetra btn btn-outline-primary m-1";

            boton.addEventListener("click", (e) => {
              this.procesarLetra(letra, e.target);
            });

            contenedor.appendChild(boton);
          });
        },

        procesarLetra(letra, boton) {
          const sonido = new Audio("/songs/mech-keyboard.mp3");
          sonido.play();

          if (this.verboArray.includes(letra)) {
            this.verboArray.forEach((car, ind) => {
              if (car === letra) {
                this.verboDashes[ind] = car;
                this.aciertos++;
                this.puntos += 10;
              }
            });

            this.spanVerbo.innerHTML = this.verboDashes.join("   ");
            this.spanPuntos.innerHTML = this.puntos;

            if (this.aciertos === this.verboArray.length) {
              const winSound = new Audio("/songs/adivinar.mp3");
              winSound.play();
              this.adivinarPasado();
            }
          } else {
            this.intentos--;
            this.errores++;
            this.puntos = Math.max(0, this.puntos - 1);
            this.spanPuntos.innerHTML = this.puntos;
            const imgId = 7 - this.intentos;
            if (imgId >= 2 && imgId <= 7) {
              document.getElementById(`img${imgId}`).style.visibility =
                "visible";
            }

            if (this.errores === this.pistaDespuesDe) {
              this.spanPista.classList.remove("oculto");
            }
            if (this.errores === 6) {
              this.creaFeedback();
              this.vidas--;
              this.perdio();
            }
          }

          boton.disabled = true;
          boton.classList.remove("btn-outline-primary");
          boton.classList.add("btn-secondary");
        },

        adivinarPasado() {
          const verbo = this.verboJuega["word"];
          this.divBotones.classList.add("d-none");
          document.getElementById("helpId").textContent =
            `Escribe el pasado simple del verbo ${verbo.toLowerCase()}`;
          this.divAdivinaPasadoTipo.classList.remove("d-none");
          this.divAdivinaPasadoTipo.classList.add("visible");
        },

        revisarPasado() {
          const form = document.getElementById("formulario");
          this.divAdivinaPasadoTipo.classList.add("d-none");

          const tipoOk = this.verboJuega["type"].toLowerCase().trim();
          const pasadoOk = this.verboJuega["simplepast"].toLowerCase().trim();
          const pasadoTest = this.pasadoUsr.value.toLowerCase().trim();

          let tipoTest = "r";
          for (const tipo of this.tipoUsr) {
            if (tipo.checked) {
              tipoTest = tipo.value;
              break;
            }
          }

          this.creaFeedback();

          if (tipoTest === tipoOk && pasadoTest === pasadoOk) {
            this.puntos += 15;
            this.gano();
          } else {
            this.vidas--;
            this.puntos = Math.max(0, this.puntos - 10);
            this.perdio();
          }

          form.reset();
        },

        gano() {
          const winSound = new Audio("/songs/win.mp3");
          winSound.play();
          document.getElementById("modalTitleId2").textContent =
            "¡Correcto :) !";
          const modalResult = new bootstrap.Modal(
            document.getElementById("modalResult"),
          );
          modalResult.show();
        },

        perdio() {
          const loseSound = new Audio("/songs/lose.mp3");
          loseSound.play();
          document.getElementById("modalTitleId2").textContent =
            "¡Incorrecto :( !";
          const modalResult = new bootstrap.Modal(
            document.getElementById("modalResult"),
          );
          modalResult.show();
        },

        valida() {
          if (this.vidas === 0) {
            this.spanVidas.innerHTML = "";
            this.perdioLasVidas = true;
            this.terminar();
          } else {
            this.iniciar();
          }
        },

        creaFeedback() {
          const resultado = `
        <tr>
          <td>Verbo:</td>
          <td>${this.verboJuega["word"].toLowerCase()}</td>
        </tr>
        <tr>
          <td>Tipo:</td>
          <td>${this.verboJuega["type"].toLowerCase() === "r" ? "regular" : "irregular"}</td>
        </tr>
        <tr>
          <td>Pasado:</td>
          <td>${this.verboJuega["simplepast"].toLowerCase()}</td>
        </tr>
        <tr>
          <td>Ejemplo:</td>
          <td>${this.verboJuega["example"]}</td>
        </tr>
      `;
          this.resultTabla.innerHTML = resultado;
        },

        async insertarJuego() {
          const datosEnviar = { nombre: this.nombre };
          try {
            const response = await fetch(
              `${window.API_URL}/api/arenagame/nuevo`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(datosEnviar),
              },
            );
            this.datosjuego = await response.json();
          } catch (error) {
            console.error("Error starting game:", error);
          }
        },

        async terminar() {
          const allSpinners = document.querySelectorAll(
            '.spinner-border, [role="status"]',
          );
          allSpinners.forEach((spinner) => {
            if (spinner && spinner.parentNode) {
              spinner.parentNode.removeChild(spinner);
            }
          });

          document.getElementById("vidas").style.display = "none";
          document.getElementById("rendirse").style.display = "none";
          document.getElementById("verbo").style.display = "none";
          document.getElementById("pista").style.display = "none";
          document.getElementById("divHangman").style.display = "none";
          document.getElementById("puntos").style.display = "none";
          this.divBotones.classList.add("d-none");

          const idSend = this.datosjuego[0]?.id || 0;
          const rindioSend = this.seRindio ? 1 : 0;
          const puntosSend = this.seRindio ? 0 : this.puntos;
          const datosEnviar = {
            id: idSend,
            puntos: puntosSend,
            rindio: rindioSend,
          };

          try {
            await fetch(`${window.API_URL}/api/arenagame/fin`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(datosEnviar),
            });
            window.location.href = "/tablageneral";
          } catch (error) {
            console.error("Error ending game:", error);
          }
        },

        aJugar() {
          this.nombre = document.getElementById("txtNombre").value;
          if (this.modalNombre) {
            this.modalNombre.hide();
          }
          this.insertarJuego();
          this.leerVerbos();
        },

        rendir() {
          this.seRindio = confirm("¿De verdad deseas rendirte?");
          if (this.seRindio) {
            const loseSound = new Audio("/songs/lose.mp3");
            loseSound.play();
            this.terminar();
          }
        },

        setupEventListeners() {
          const nameForm = document.querySelector("#modalNombre form");
          if (nameForm) {
            nameForm.addEventListener("submit", (e) => {
              e.preventDefault();
              this.aJugar();
            });
          }

          const cancelBtn = document.querySelector(
            "#modalNombre [data-bs-dismiss='modal']",
          );
          if (cancelBtn) {
            cancelBtn.addEventListener("click", () => {
              window.location.href = "/";
            });
          }

          const resultOkBtn = document.querySelector(
            "#modalResult button[data-bs-dismiss='modal']",
          );
          if (resultOkBtn) {
            resultOkBtn.addEventListener("click", () => {
              this.valida();
            });
          }

          const surrenderBtn = document.getElementById("btnRendirse");
          if (surrenderBtn) {
            surrenderBtn.addEventListener("click", () => {
              this.rendir();
            });
          }

          const pastForm = document.getElementById("formulario");
          if (pastForm) {
            pastForm.addEventListener("submit", (e) => {
              e.preventDefault();
              this.revisarPasado();
            });
          }
        },

        init() {
          this.spanVidas = document.querySelector(".spanVidas");
          this.spanPuntos = document.querySelector(".spanPuntos");
          this.spanVerbo = document.querySelector(".spanVerbo");
          this.spanPista = document.querySelector(".spanPista");
          this.divHangman = document.getElementById("divHangman");
          this.divBotones = document.getElementById("divBotones");
          this.divAdivinaPasadoTipo = document.getElementById(
            "divAdivinaPasadoTipo",
          );
          this.resultTabla = document.getElementById("resultTabla");
          this.pasadoUsr = document.getElementById("txtPasado");
          this.tipoUsr = document.getElementsByName("tipoV");
          this.spinner = document.getElementById("loading");

          this.setupEventListeners();

          if (this.spanVidas && this.spanPuntos) {
            this.spanPuntos.innerHTML = "0";
          }
        },
      };

      document.addEventListener("DOMContentLoaded", () => {
        try {
          const spinners = document.querySelectorAll(
            '.spinner-border, [role="status"]',
          );
          spinners.forEach((spinner) => {
            if (spinner && spinner.parentNode) {
              spinner.parentNode.removeChild(spinner);
            }
          });

          hangmanApp.modalNombre = new bootstrap.Modal(
            document.getElementById("modalNombre"),
          );
          hangmanApp.modalNombre.show();

          hangmanApp.init();
        } catch (error) {
          console.error("Error en inicialización:", error);
          setTimeout(() => {
            try {
              const spinners = document.querySelectorAll(
                '.spinner-border, [role="status"]',
              );
              spinners.forEach((spinner) => {
                if (spinner && spinner.parentNode) {
                  spinner.parentNode.removeChild(spinner);
                }
              });

              hangmanApp.modalNombre = new bootstrap.Modal(
                document.getElementById("modalNombre"),
              );
              hangmanApp.modalNombre.show();
              hangmanApp.init();
            } catch (err) {
              console.error("Error en reintento de inicialización:", err);
            }
          }, 500);
        }
      });
    }
  </script>

  <!-- Añade este estilo para asegurar que no quede espacio en blanco -->
  <style>
    /* Eliminar espacios innecesarios de spinners */
    .spinner-border,
    [role="status"] {
      display: none !important;
      height: 0 !important;
      width: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      opacity: 0 !important;
      position: absolute !important;
      visibility: hidden !important;
      overflow: hidden !important;
    }

    /* Asegurar que solo haya un main */
    main:not(:first-of-type) {
      display: none !important;
    }
  </style>
</ArenaLayout>
